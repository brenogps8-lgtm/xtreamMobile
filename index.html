<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xtream Player Pro - Public</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        :root {
            --accent-pink: #d946ef;
            --accent-purple: #8b5cf6;
            --bg-dark: #050505;
            --bg-sidebar: #0f0f0f;
            --bg-card: #141414;
            --text-white: #ffffff;
            --gradient-btn: linear-gradient(90deg, #8b5cf6 0%, #d946ef 100%);
            
            --header-height: 80px; 
            --bottom-nav-height: 70px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-white); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- TELA DE LOGIN --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1574375927938-d5a98e8efe30?q=80&w=1000&auto=format&fit=crop');
            background-size: cover; background-position: center;
        }
        .login-box {
            width: 90%; max-width: 400px;
            background: rgba(20, 20, 20, 0.95);
            padding: 40px 30px; border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .login-logo { font-size: 2rem; font-weight: 900; color: var(--accent-pink); margin-bottom: 30px; letter-spacing: 1px; }
        .login-input {
            width: 100%; padding: 15px; margin-bottom: 15px;
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 50px; color: white; font-size: 1rem; text-align: center;
        }
        .login-input:focus { border-color: var(--accent-purple); background: black; }
        .login-btn {
            width: 100%; padding: 15px; margin-top: 10px;
            background: var(--gradient-btn); border: none;
            border-radius: 50px; color: white; font-weight: 800; font-size: 1rem;
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }
        .login-server-info { margin-top: 20px; font-size: 0.8rem; color: #666; }

        /* --- TOPBAR --- */
        .topbar {
            height: var(--header-height); 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
            padding: 15px 20px; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.6) 50%, transparent 100%);
            position: fixed; top: 0; left: 0; width: 100%; z-index: 100;
            pointer-events: none; 
        }
        .topbar > * { pointer-events: auto; }

        .logo { font-size: 1.1rem; font-weight: 900; color: var(--accent-pink); margin-top: 8px; margin-right: 15px; text-shadow: 0 2px 10px rgba(0,0,0,0.8); }

        .search-box {
            display: flex; align-items: center; 
            background: rgba(20, 20, 20, 0.7); 
            backdrop-filter: blur(10px);
            border-radius: 50px; 
            padding: 8px 15px;
            flex: 1; 
            border: 1px solid rgba(255,255,255,0.1); 
            transition: 0.3s;
            max-width: 500px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .search-box:focus-within { border-color: var(--accent-purple); background: #000; }
        .search-input { background: transparent; border: none; color: white; padding: 0 10px; outline: none; width: 100%; font-weight: 500; font-size: 0.9rem; }
        .search-btn-icon { color: #ccc; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--bottom-nav-height);
            background: rgba(10, 10, 10, 0.98);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
            padding-bottom: 5px; 
        }

        .nav-btn {
            background: transparent; border: none; color: #666; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; cursor: pointer; transition: 0.3s;
            flex: 1; height: 100%;
        }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-btn span { font-size: 0.7rem; font-weight: 600; }
        .nav-btn.active { color: var(--accent-pink); }
        .nav-btn.active i { transform: translateY(-3px); text-shadow: 0 0 15px var(--accent-pink); }

        .back-btn-float { 
            position: fixed; bottom: 90px; right: 20px; 
            width: 50px; height: 50px; border-radius: 50%; 
            background: var(--accent-purple); color: white; border: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); z-index: 101; 
            display: none; align-items: center; justify-content: center; font-size: 1.2rem;
        }
        .back-btn-float.show { display: flex; }

        /* --- LAYOUT --- */
        .main-layout { display: flex; height: 100vh; width: 100%; padding-top: var(--header-height); padding-bottom: var(--bottom-nav-height); }
        
        .cat-sidebar { 
            width: 90px; background: var(--bg-sidebar); border-right: 1px solid #222; 
            overflow-y: auto; flex-shrink: 0; padding: 10px; 
            display: flex; flex-direction: column; align-items: center;
        }
        @media (min-width: 768px) { .cat-sidebar { width: 250px; align-items: stretch; } }

        .cat-title-header { font-size: 0.7rem; color: #555; font-weight: 700; margin-bottom: 10px; text-align: center; text-transform: uppercase; }
        .cat-item { 
            padding: 12px 5px; margin-bottom: 5px; border-radius: 10px; cursor: pointer; color: #888; 
            font-size: 0.75rem; transition: 0.2s; font-weight: 500; text-align: center; border: 1px solid transparent; width: 100%;
            word-break: break-word;
        }
        @media (min-width: 768px) { .cat-item { text-align: left; padding-left: 15px; font-size: 0.9rem; } }
        .cat-item:hover { background: #1f1f1f; color: white; }
        .cat-item.active { background: rgba(139, 92, 246, 0.15); color: var(--accent-purple); border-color: var(--accent-purple); font-weight: 700; }

        .logout-btn-sidebar {
            margin-top: auto; padding: 10px; width: 100%; text-align: center;
            color: #ff4444; font-size: 0.7rem; cursor: pointer; border-top: 1px solid #222;
        }

        .content-grid-area { flex: 1; overflow-y: auto; padding: 10px; background: var(--bg-dark); }
        .section-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 20px; color: white; padding-left: 10px; }

        .media-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); 
            gap: 10px; padding-bottom: 20px; 
        }
        @media (min-width: 600px) { .media-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; } }

        .fav-filters { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding: 0 10px 10px 10px; }
        .fav-filter-btn { padding: 6px 16px; background: #1f1f1f; border-radius: 20px; color: #aaa; cursor: pointer; font-weight: bold; font-size: 0.8rem; white-space: nowrap; }
        .fav-filter-btn.active { background: var(--text-white); color: black; }

        .card { 
            background: var(--bg-card); border-radius: 8px; overflow: hidden; position: relative; 
            cursor: pointer; aspect-ratio: 2/3; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .card:focus, .card:hover { transform: scale(1.05); z-index: 10; outline: 3px solid var(--accent-pink); }
        .card img { width: 100%; height: 100%; object-fit: cover; background: #222; }
        
        .type-badge { position: absolute; top: 5px; right: 5px; padding: 2px 6px; border-radius: 4px; font-size: 0.55rem; font-weight: 800; text-transform: uppercase; color: white; z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .badge-movie { background: var(--accent-purple); }
        .badge-series { background: var(--accent-pink); }
        .badge-live { background: #ef4444; }
        
        .card-title {
            position: absolute; bottom: 0; width: 100%; padding: 40px 5px 5px 5px;
            background: linear-gradient(to top, rgba(0,0,0,1) 10%, transparent);
            font-size: 0.75rem; text-align: center; color: white; font-weight: 600; pointer-events: none;
        }
        .card-progress-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: rgba(255,255,255,0.3); z-index: 6; }
        .card-progress-fill { height: 100%; background: var(--accent-pink); width: 0%; }

        /* --- HOME HERO --- */
        #home-view { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-dark); z-index: 50; overflow-y: auto; 
            padding-bottom: var(--bottom-nav-height);
        }
        .hero-banner { height: 60vh; width: 100%; position: relative; display: flex; align-items: flex-end; padding-bottom: 30px; }
        .hero-backdrop { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%); z-index: 1; opacity: 0.8; }
        .hero-content { position: relative; z-index: 3; padding: 0 20px; width: 100%; text-shadow: 0 2px 10px black; }
        .hero-greeting { font-size: 0.9rem; color: var(--accent-pink); font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .hero-title-large { font-size: 2.5rem; font-weight: 900; line-height: 1.1; margin-bottom: 15px; }
        .hero-buttons { display: flex; gap: 10px; }
        .btn-hero { padding: 10px 25px; border: none; border-radius: 50px; font-size: 0.9rem; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; background: white; color: black; }
        .btn-hero.secondary { background: rgba(255, 255, 255, 0.2); color: white; backdrop-filter: blur(10px); }

        .home-rows { padding: 10px 0; }
        .home-section { padding: 0 20px; margin-bottom: 30px; }
        .home-section-title { color: white; font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .horizontal-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; scroll-behavior: smooth; }
        .card-home { min-width: 110px; width: 110px; aspect-ratio: 2/3; background: var(--bg-card); border-radius: 8px; overflow: hidden; position: relative; flex-shrink: 0; }
        .card-home img { width: 100%; height: 100%; object-fit: cover; }

        /* --- DETAILS OVERLAY --- */
        #details-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; display: none;
            flex-direction: column; overflow-y: auto;
        }
        .details-header { height: 40vh; width: 100%; background-size: cover; background-position: top; position: relative; flex-shrink: 0; }
        .details-header::after { content:''; position: absolute; top:0; left:0; width:100%; height:100%; background: linear-gradient(to top, #000 5%, transparent 100%); }
        .details-content-layer { 
            position: relative; margin-top: -60px; padding: 0 20px; 
            display: flex; flex-direction: column; gap: 20px; z-index: 10; padding-bottom: 80px; 
        }
        @media(min-width: 768px) { .details-content-layer { flex-direction: row; align-items: flex-end; margin-top: -100px; padding: 0 50px 50px 50px; } }

        .details-poster { width: 140px; aspect-ratio: 2/3; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.8); object-fit: cover; background: #222; align-self: center; }
        .details-info { flex: 1; text-align: center; }
        @media(min-width: 768px) { .details-info { text-align: left; } }
        
        .details-title { font-size: 1.8rem; font-weight: 900; margin-bottom: 10px; line-height: 1.1; }
        .details-meta { display: flex; gap: 8px; justify-content: center; margin-bottom: 15px; font-size: 0.8rem; color: #ccc; flex-wrap: wrap; }
        @media(min-width: 768px) { .details-meta { justify-content: flex-start; } }
        .meta-tag { padding: 4px 8px; background: rgba(255,255,255,0.15); border-radius: 4px; font-weight: bold; }
        
        .details-plot { font-size: 0.95rem; color: #ccc; margin-bottom: 20px; line-height: 1.5; max-height: 150px; overflow-y: auto; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; text-align: left; }

        .cast-section { width: 100%; overflow: hidden; margin-bottom: 20px; }
        .cast-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; }
        .cast-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid #333; }
        
        /* --- SIMILARES AUMENTADOS --- */
        .similar-section { width: 100%; margin-top: 10px; }
        .similar-title { font-weight: 700; margin-bottom: 10px; color: #ddd; font-size: 1rem; text-align: left; }
        .similar-list { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .similar-card { 
            min-width: 140px; width: 140px; /* Aumentado para 140px */
            aspect-ratio: 2/3; 
            background: #1f1f1f; border-radius: 8px; 
            overflow: hidden; position: relative; flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .similar-card img { width: 100%; height: 100%; object-fit: cover; }
        .similar-card-title { 
            position: absolute; bottom: 0; width: 100%; padding: 30px 2px 5px 2px;
            background: linear-gradient(to top, black, transparent); 
            font-size: 0.7rem; text-align: center; color: white; 
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .close-details-btn { position: absolute; top: 20px; right: 20px; z-index: 20; background: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; backdrop-filter: blur(5px); }

        .episodes-area { background: #0a0a0a; border-radius: 12px; padding: 15px; margin-top: 20px; text-align: left; }
        .season-tabs { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px; }
        .season-tab { padding: 6px 15px; background: #222; border-radius: 20px; font-size: 0.85rem; color: #aaa; white-space: nowrap; }
        .season-tab.active { background: white; color: black; }
        .episode-item { display: flex; align-items: center; gap: 15px; background: #161616; padding: 10px; border-radius: 8px; margin-bottom: 8px; }

        /* PLAYER */
        #player-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 3000; display: none; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; }
        .player-actions { position: absolute; top: 20px; right: 20px; display: flex; gap: 15px; z-index: 3001; }
        .player-btn { background: rgba(0,0,0,0.5); color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }

        .loader { position: fixed; top:50%; left:50%; transform: translate(-50%, -50%); display: none; color: var(--accent-purple); font-size: 3rem; z-index: 4000;}
        :focus-visible { outline: 3px solid var(--accent-pink); }
    </style>
</head>
<body>

    <div id="login-overlay" style="display: none;">
        <div class="login-box">
            <div class="login-logo">Xtream Pro</div>
            <input type="text" id="login-user" class="login-input" placeholder="Usuário" autocomplete="off">
            <input type="password" id="login-pass" class="login-input" placeholder="Senha" autocomplete="off">
            <button class="login-btn" onclick="performLogin()">Entrar</button>
            <div class="login-server-info" id="server-display">Server: invictosserver.xyz</div>
        </div>
    </div>

    <header class="topbar">
        <div class="logo">Xtream</div>
        <div class="search-box">
            <i class="fas fa-search search-btn-icon" onclick="performGlobalSearch()"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Pesquisar..." onkeypress="handleSearchEnter(event)">
        </div>
    </header>

    <button class="back-btn-float" id="back-btn-container" onclick="goBack()"><i class="fas fa-arrow-left"></i></button>
    <div class="loader" id="loader"><i class="fas fa-spinner fa-spin"></i></div>

    <div id="home-view">
        <div class="hero-banner">
            <div class="hero-backdrop" id="hero-backdrop"></div>
            <div class="hero-overlay"></div>
            <div class="hero-content">
                <div class="hero-greeting">Bem-Vindo</div>
                <h1 class="hero-title-large" id="hero-title">Carregando...</h1>
                <div class="hero-meta" id="hero-meta"></div>
                <div class="hero-buttons" id="hero-buttons-container" style="display: none;">
                    <button class="btn-hero primary" id="hero-btn-play"><i class="fas fa-play"></i> Assistir</button>
                    <button class="btn-hero secondary" id="hero-btn-list"><i class="fas fa-plus"></i> Lista</button>
                </div>
            </div>
        </div>
        <div class="home-rows">
            <div id="home-history" class="home-section" style="display: none;">
                <div class="home-section-title"><i class="fas fa-history"></i> Continue Assistindo</div>
                <div id="history-scroll" class="horizontal-scroll"></div>
            </div>
            <div id="home-recommendations" class="home-section" style="display: none;">
                <div class="home-section-title"><i class="fas fa-fire-alt"></i> Populares (TMDB)</div>
                <div id="recommendations-scroll" class="horizontal-scroll"></div>
            </div>
        </div>
    </div>

    <div class="main-layout" id="main-content" style="display: none;">
        <div class="cat-sidebar" id="sidebar-container"></div>
        <div class="content-grid-area">
            <h2 class="section-title" id="page-title">Filmes</h2>
            <div id="fav-filters" class="fav-filters" style="display: none;">
                <div class="fav-filter-btn active" onclick="filterFavorites('all', event)">Todos</div>
                <div class="fav-filter-btn" onclick="filterFavorites('movie', event)">Filmes</div>
                <div class="fav-filter-btn" onclick="filterFavorites('series', event)">Séries</div>
            </div>
            <div class="media-grid" id="grid-container"></div>
        </div>
    </div>

    <div id="details-overlay">
        <div class="close-details-btn" onclick="closeDetails()"><i class="fas fa-times"></i></div>
        <div class="details-header" id="dt-header-bg"></div>
        <div class="details-content-layer">
            <img src="" class="details-poster" id="dt-poster" onerror="this.src='https://placehold.co/200x300?text=Sem+Capa'">
            <div class="details-info">
                <h1 class="details-title" id="dt-title">Título</h1>
                <div class="details-meta" id="dt-meta"></div>
                <div class="hero-buttons" style="justify-content: center; margin-bottom: 20px;">
                    <button class="btn-hero primary" id="dt-btn-play"><i class="fas fa-play"></i> Assistir</button>
                    <button class="btn-hero secondary" id="dt-btn-fav" onclick="toggleFavoriteFromDetails()"><i class="fas fa-plus"></i> Lista</button>
                </div>
                <div class="details-plot" id="dt-plot">...</div>
                
                <div class="cast-section" id="cast-section" style="display: none;">
                    <div style="font-weight:bold; margin-bottom:5px; color:#ddd;">Elenco</div>
                    <div class="cast-list" id="dt-cast-list"></div>
                </div>

                <div class="similar-section" id="similar-section" style="display: none;">
                    <div class="similar-title">Similares</div>
                    <div class="similar-list" id="similar-list"></div>
                </div>

                <div class="episodes-area" id="dt-episodes-area" style="display: none;">
                    <div class="season-tabs" id="season-tabs"></div>
                    <div class="episodes-list" id="episodes-list"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="player-overlay">
        <div class="player-actions">
            <div class="player-btn" id="fav-btn" onclick="toggleFavorite()"><i class="far fa-heart"></i></div>
            <div class="player-btn" onclick="closePlayer()"><i class="fas fa-times"></i></div>
        </div>
        <video id="videoPlayer" controls autoplay playsinline></video>
    </div>

    <nav class="bottom-nav">
        <button class="nav-btn active" id="nav-home" onclick="goHome()"><i class="fas fa-home"></i> <span>Home</span></button>
        <button class="nav-btn" id="nav-movie" onclick="loadSection('movie')"><i class="fas fa-film"></i> <span>Filmes</span></button>
        <button class="nav-btn" id="nav-series" onclick="loadSection('series')"><i class="fas fa-tv"></i> <span>Séries</span></button>
        <button class="nav-btn" id="nav-live" onclick="loadSection('live')"><i class="fas fa-broadcast-tower"></i> <span>Ao Vivo</span></button>
        <button class="nav-btn" id="nav-fav" onclick="loadFavorites()"><i class="fas fa-heart"></i> <span>Lista</span></button>
    </nav>

    <script>
        // CONFIGURAÇÃO INICIAL - DNS FIXO, CREDENCIAIS VÊM DO LOCALSTORAGE
        const CONFIG = { 
            dns: "http://invictosserver.xyz", 
            user: localStorage.getItem('xtream_user') || "", 
            pass: localStorage.getItem('xtream_pass') || "", 
            tmdbKey: "7a8d3337948e00a827f162c7f8684776" 
        };
        const IMG_FALLBACK = "https://placehold.co/200x300?text=No+Image";
        let currentType = ''; let currentItem = null; let currentSeriesData = null; let cachedAllMovies = null;

        // INICIALIZAÇÃO
        document.addEventListener('DOMContentLoaded', () => {
            if(!CONFIG.user || !CONFIG.pass) {
                // Se não tiver login salvo, mostra a tela de login
                document.getElementById('login-overlay').style.display = 'flex';
            } else {
                // Se já tiver, inicia o app
                initApp();
            }
        });

        // FUNÇÕES DE LOGIN
        function performLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            if(u && p) {
                localStorage.setItem('xtream_user', u);
                localStorage.setItem('xtream_pass', p);
                CONFIG.user = u;
                CONFIG.pass = p;
                document.getElementById('login-overlay').style.display = 'none';
                initApp();
            } else {
                alert("Por favor, preencha usuário e senha.");
            }
        }
        function logout() {
            if(confirm("Deseja sair e limpar os dados de login?")) {
                localStorage.removeItem('xtream_user');
                localStorage.removeItem('xtream_pass');
                location.reload();
            }
        }

        function initApp() {
            setupHorizontalScroll(); 
            renderHomeHistory(); 
            initHomeWithTMDB();
            setTimeout(ensureGlobalMovieList, 2000); 
            updateBackButton();
        }

        // --- CARREGAR FAVORITOS (SOMENTE VOD) ---
        function loadFavorites(filter = 'all') {
            currentType = 'favorites'; 
            setActiveNav('nav-fav'); 
            
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('main-content').style.display = 'flex';
            document.getElementById('details-overlay').style.display = 'none';
            document.getElementById('fav-filters').style.display = 'flex'; 
            
            document.getElementById('page-title').innerText = 'Minha Lista';
            document.getElementById('sidebar-container').innerHTML = ''; 
            document.getElementById('grid-container').innerHTML = '';

            const allFavs = JSON.parse(localStorage.getItem('my_favorites') || '[]');
            
            // FILTRA PARA REMOVER TV AO VIVO DAQUI (Aparecerá só na aba TV)
            let filtered = allFavs.filter(i => i._savedType !== 'live' && isSafe(i.name || i.title));

            if(filter !== 'all') {
                if(filter === 'movie') filtered = filtered.filter(i => i._savedType === 'movie');
                else if(filter === 'series') filtered = filtered.filter(i => i._savedType === 'series');
            }
            renderGrid(filtered);
            updateBackButton();
        }

        function filterFavorites(type, event) {
            document.querySelectorAll('.fav-filter-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadFavorites(type);
        }

        function updateBackButton() {
            const home = document.getElementById('home-view').style.display !== 'none';
            const btn = document.getElementById('back-btn-container');
            if(!home) btn.classList.add('show'); else btn.classList.remove('show');
        }
        function goBack() {
            if(document.getElementById('player-overlay').style.display === 'flex') { closePlayer(); return; }
            if(document.getElementById('details-overlay').style.display === 'flex') { closeDetails(); return; }
            goHome();
        }
        function setupHorizontalScroll() {
            document.querySelectorAll('.horizontal-scroll, .cast-list, .similar-list').forEach(c => {
                c.addEventListener('wheel', (evt) => { if (evt.deltaY !== 0) { evt.preventDefault(); c.scrollLeft += evt.deltaY; } });
            });
        }
        const BAD_WORDS = ["XXX", "ADULTO", "ADULT", "PORN", "SEX", "EROTIC", "HENTAI", "+18", "18+", "AMADOR", "SWING", "INCEST", "TABOO", "UNCENSORED", "VOLUPTU", "PLAYBOY", "VENUS", "SEXTREME", "PRIVATE", "BRASILEIRINHAS", "REDLIGHT", "HOT", "NUDE", "ONLYFANS", "PRIVAT", "X-RATED", "HARDCORE"];
        function isSafe(str) { if (!str) return false; const up = str.toUpperCase(); for (let word of BAD_WORDS) { if (up.includes(word)) return false; } return true; }
        function cleanName(str) { if(!str) return ""; return str.replace(/Brasileirinhas:/gi, '').replace(/Adulto:\s*/gi, '').replace(/Adulto\s*-\s*/gi, '').replace(/\[L\]/gi, '').replace(/\[4k\]/gi, '').replace(/\[FHD\]/gi, '').replace(/\[HD\]/gi, '').replace(/\[.*?\]/g, '').replace(/\(.*?\)/g, '').replace(/BR -/gi, '').replace(/LEG -/gi, '').replace(/ - /g, ' ').trim(); }
        function normalizeStr(str) { if(!str) return ""; return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/g, ""); }
        function getUniqueItems(items) {
            const uniqueMap = new Map(); items.forEach(item => { const clean = cleanName(item.name || item.title); const normalized = normalizeStr(clean); if(!uniqueMap.has(normalized)) uniqueMap.set(normalized, item); }); return Array.from(uniqueMap.values());
        }
        function getRandomItems(arr, count) { if(!arr) return []; return [...arr].sort(() => 0.5 - Math.random()).slice(0, count); }

        async function ensureGlobalMovieList() {
            if(cachedAllMovies) return cachedAllMovies;
            try { const res = await fetch(`${CONFIG.dns}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=get_vod_streams`); const data = await res.json(); cachedAllMovies = data.filter(m => isSafe(m.name)); return cachedAllMovies; } catch(e) { return []; }
        }

        async function initHomeWithTMDB() {
            document.getElementById('home-recommendations').style.display = 'block';
            document.getElementById('recommendations-scroll').innerHTML = '<div style="padding:20px">Carregando sugestões...</div>';
            try {
                const resTmdb = await fetch(`https://api.themoviedb.org/3/trending/movie/week?api_key=${CONFIG.tmdbKey}&language=pt-BR`);
                const dataTmdb = await resTmdb.json(); const tmdbMovies = dataTmdb.results || [];
                const matched = await crossReferenceTitles(tmdbMovies.map(m => m.title), 15);
                if(matched.length > 0) { renderRecommendations(matched); const heroItem = matched[0]; heroItem._recType = 'movie'; updateHero(heroItem); } 
                else { document.getElementById('recommendations-scroll').innerHTML = 'Nada encontrado.'; }
            } catch(e) {}
        }

        async function loadHybridRecommendations(item) {
            const section = document.getElementById('similar-section'); const list = document.getElementById('similar-list');
            section.style.display = 'none'; list.innerHTML = '';
            const clean = cleanName(item.name || item.title);
            let mixedResults = [];
            try {
                const search = await fetch(`https://api.themoviedb.org/3/search/movie?api_key=${CONFIG.tmdbKey}&query=${encodeURIComponent(clean)}&language=pt-BR`);
                const sData = await search.json();
                if(sData.results && sData.results.length > 0) {
                    const tmdbId = sData.results[0].id;
                    const recs = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}/recommendations?api_key=${CONFIG.tmdbKey}&language=pt-BR`);
                    const rData = await recs.json();
                    const titles = (rData.results || []).map(m => m.title).slice(0, 15);
                    mixedResults = await crossReferenceTitles(titles, 10);
                }
            } catch(e) {}
            if(mixedResults.length < 10 && item.category_id) {
                const all = await ensureGlobalMovieList();
                const sameCategory = all.filter(m => m.category_id === item.category_id && m.stream_id !== item.stream_id && isSafe(m.name));
                mixedResults = [...mixedResults, ...getRandomItems(sameCategory, 15 - mixedResults.length)];
            }
            const uniqueFinal = getUniqueItems(mixedResults);
            if(uniqueFinal.length > 0) {
                section.style.display = 'block';
                uniqueFinal.forEach(it => {
                    const card = document.createElement('div'); card.className = 'similar-card';
                    const img = it.stream_icon || it.cover || IMG_FALLBACK;
                    card.innerHTML = `<img src="${img}" loading="lazy"><div class="similar-card-title">${it.name || it.title}</div>`;
                    card.onclick = () => openMovieDetails(it); list.appendChild(card);
                });
            }
        }

        async function searchByActorTMDB(actorName) {
            showLoader(true);
            try {
                const search = await fetch(`https://api.themoviedb.org/3/search/person?api_key=${CONFIG.tmdbKey}&query=${encodeURIComponent(actorName)}&language=pt-BR`);
                const sData = await search.json();
                if(!sData.results || sData.results.length === 0) { alert("Ator não encontrado."); showLoader(false); return; }
                const personId = sData.results[0].id;
                const credits = await fetch(`https://api.themoviedb.org/3/person/${personId}/movie_credits?api_key=${CONFIG.tmdbKey}&language=pt-BR`);
                const cData = await credits.json();
                const matched = await crossReferenceTitles((cData.cast || []).map(m => m.title).slice(0, 50), 50);
                matched.forEach(m => m._searchType = 'movie');
                currentType = 'search'; setActiveNav(null);
                document.getElementById('home-view').style.display = 'none'; document.getElementById('details-overlay').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex'; document.getElementById('page-title').innerText = `Filmografia: ${actorName}`;
                document.getElementById('sidebar-container').innerHTML = '';
                renderGrid(matched, true); 
            } catch(e) {} showLoader(false);
        }

        async function crossReferenceTitles(titles, limit = 20) {
            if(!titles || titles.length === 0) return [];
            const allMovies = await ensureGlobalMovieList();
            const normTitles = titles.map(t => normalizeStr(t));
            const matches = []; const addedNames = new Set();
            for(const m of allMovies) {
                if(matches.length >= limit) break;
                if(!isSafe(m.name)) continue;
                const normName = normalizeStr(cleanName(m.name));
                if(addedNames.has(normName)) continue;
                for(const t of normTitles) { if(normName.includes(t)) { m._recType = 'movie'; matches.push(m); addedNames.add(normName); break; } }
            } return matches;
        }

        function updateHero(item) {
            document.getElementById('hero-title').innerText = item.name || item.title;
            const img = item.stream_icon || item.cover || IMG_FALLBACK;
            document.getElementById('hero-backdrop').style.backgroundImage = `url('${img}')`;
            document.getElementById('hero-meta').innerHTML = `<span>Populares da Semana</span>`;
            document.getElementById('hero-buttons-container').style.display = 'flex';
            document.getElementById('hero-btn-play').onclick = () => { if(item._recType === 'series') openSeriesDetails(item); else openMovieDetails(item); };
        }

        function renderRecommendations(items) {
            const container = document.getElementById('recommendations-scroll'); container.innerHTML = '';
            const unique = getUniqueItems(items);
            unique.forEach(item => {
                const card = document.createElement('div'); card.className = 'card-home';
                const img = item.stream_icon || item.cover || IMG_FALLBACK;
                card.innerHTML = `<img src="${img}"><div class="card-title">${item.name || item.title}</div>`;
                card.onclick = () => { if(item._recType === 'series') openSeriesDetails(item); else openMovieDetails(item); };
                container.appendChild(card);
            }); setupHorizontalScroll();
        }

        function handleSearchEnter(e) { if(e.key === 'Enter') performGlobalSearch(); }
        async function performGlobalSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if(query.length < 3) return;
            currentType = 'search'; setActiveNav(null);
            document.getElementById('home-view').style.display = 'none'; document.getElementById('details-overlay').style.display = 'none'; 
            document.getElementById('main-content').style.display = 'flex'; document.getElementById('page-title').innerText = `Busca: "${query}"`;
            document.getElementById('sidebar-container').innerHTML = ''; document.getElementById('grid-container').innerHTML = '';
            updateBackButton(); showLoader(true);
            try {
                const movies = await ensureGlobalMovieList();
                const resSer = await fetch(`${CONFIG.dns}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=get_series`);
                const series = await resSer.json();
                const normQuery = normalizeStr(query);
                const rMov = movies.filter(m => normalizeStr(m.name).includes(normQuery)).map(m => ({...m, _searchType: 'movie'}));
                const rSer = series.filter(s => isSafe(s.name) && normalizeStr(s.name).includes(normQuery)).map(s => ({...s, _searchType: 'series'}));
                renderGrid([...rMov, ...rSer], true);
            } catch(e) {} showLoader(false);
        }

        function goHome() {
            setActiveNav('nav-home');
            document.getElementById('home-view').style.display = 'block'; document.getElementById('main-content').style.display = 'none';
            document.getElementById('details-overlay').style.display = 'none';
            updateBackButton(); renderHomeHistory(); initHomeWithTMDB();
        }

        async function loadSection(type) {
            currentType = type; document.getElementById('searchInput').value = '';
            document.getElementById('home-view').style.display = 'none'; document.getElementById('main-content').style.display = 'flex';
            document.getElementById('fav-filters').style.display = 'none';
            updateBackButton(); 
            setActiveNav(type === 'movie' ? 'nav-movie' : (type === 'series' ? 'nav-series' : (type === 'live' ? 'nav-live' : 'nav-fav')));
            document.getElementById('page-title').innerText = type === 'live' ? 'TV' : (type === 'movie' ? 'Filmes' : 'Séries');
            document.getElementById('sidebar-container').innerHTML = '...'; document.getElementById('grid-container').innerHTML = '';
            showLoader(true);
            try {
                let actionCat = type === 'series' ? 'get_series_categories' : (type === 'live' ? 'get_live_categories' : 'get_vod_categories');
                const res = await fetch(`${CONFIG.dns}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=${actionCat}`);
                const categories = await res.json();
                const safeCats = categories.filter(c => c && isSafe(c.category_name));
                renderCategoriesSidebar(safeCats);
                if(safeCats.length > 0) loadItems(safeCats[0].category_id);
            } catch (e) {} showLoader(false);
        }

        function renderCategoriesSidebar(cats) {
            const container = document.getElementById('sidebar-container');
            container.innerHTML = `<div class="cat-title-header">Categorias</div>`;
            if(currentType === 'live') {
                const favBtn = document.createElement('div'); favBtn.className = 'cat-item'; favBtn.id = 'cat-fav-live'; favBtn.innerText = '★ FAVORITOS';
                favBtn.onclick = () => loadItems('fav_live'); container.appendChild(favBtn);
            } else {
                const allBtn = document.createElement('div'); allBtn.className = 'cat-item'; allBtn.id = 'cat-all'; allBtn.innerText = '★ TODOS';
                allBtn.onclick = () => loadItems('all'); container.appendChild(allBtn);
            }
            cats.forEach(cat => {
                const div = document.createElement('div'); div.className = 'cat-item'; div.id = `cat-${cat.category_id}`; div.innerText = cat.category_name;
                div.onclick = () => loadItems(cat.category_id); container.appendChild(div);
            });
            
            // Botão de Logout na Sidebar
            const logoutDiv = document.createElement('div');
            logoutDiv.className = 'logout-btn-sidebar';
            logoutDiv.innerHTML = '<i class="fas fa-sign-out-alt"></i> Sair da Conta';
            logoutDiv.onclick = logout;
            container.appendChild(logoutDiv);
        }

        async function loadItems(catId) {
            showLoader(true);
            document.querySelectorAll('.cat-item').forEach(b => b.classList.remove('active'));
            let activeId = catId === 'all' ? 'cat-all' : (catId === 'fav_live' ? 'cat-fav-live' : `cat-${catId}`);
            const btn = document.getElementById(activeId); if(btn) btn.classList.add('active');

            // SE CLICAR EM FAVORITOS NA ABA DE TV
            if(catId === 'fav_live') {
                const allFavs = JSON.parse(localStorage.getItem('my_favorites') || '[]');
                // Mostra APENAS canais de TV
                const liveFavs = allFavs.filter(i => (i._savedType === 'live' || i.stream_type === 'live') && isSafe(i.name));
                renderGrid(liveFavs); showLoader(false); return;
            }
            
            let action = currentType === 'series' ? 'get_series' : (currentType === 'live' ? 'get_live_streams' : 'get_vod_streams');
            try {
                let url = `${CONFIG.dns}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=${action}`;
                if(catId !== 'all') url += `&category_id=${catId}`;
                const res = await fetch(url); const data = await res.json();
                let safeData = data.filter(item => item && isSafe(item.name || item.title));
                if(catId === 'all' && safeData.length > 500) safeData = safeData.slice(0, 500);
                renderGrid(safeData);
            } catch(e) {} showLoader(false);
        }

        function renderGrid(items, isSearch = false) {
            const container = document.getElementById('grid-container'); container.innerHTML = '';
            if(!items || items.length === 0) { container.innerHTML = '<div style="color:#666;">Nada encontrado.</div>'; return; }
            const uniqueItems = getUniqueItems(items);
            uniqueItems.forEach(item => {
                const card = document.createElement('div'); card.className = 'card';
                let itemType = item._recType || item._searchType || item._savedType || currentType;
                if(!itemType) { if(item.series_id) itemType = 'series'; else if(item.stream_type === 'live') itemType = 'live'; else if(item.stream_id) itemType = 'movie'; }
                
                let badgeHtml = '';
                if(itemType === 'movie') badgeHtml = `<div class="type-badge badge-movie">FILME</div>`;
                else if(itemType === 'series') badgeHtml = `<div class="type-badge badge-series">SÉRIE</div>`;
                else if(itemType === 'live') badgeHtml = `<div class="type-badge badge-live">AO VIVO</div>`;
                
                let progressHtml = '';
                const id = item.stream_id || item.series_id;
                if(itemType === 'movie') {
                    const history = JSON.parse(localStorage.getItem('watch_history') || '[]');
                    const found = history.find(h => h.fullItem && (h.fullItem.stream_id || h.fullItem.series_id) === id && h.type === 'movie');
                    if(found && found.time && found.duration) { const pct = (found.time / found.duration) * 100; progressHtml = `<div class="card-progress-container"><div class="card-progress-fill" style="width: ${pct}%"></div></div>`; }
                }
                const img = item.stream_icon || item.cover || IMG_FALLBACK;
                card.innerHTML = `${badgeHtml}<img src="${img}" loading="lazy"><div class="card-title">${item.name || item.title}</div>${progressHtml}`;
                card.onclick = () => { if(itemType === 'series') openSeriesDetails(item); else if(itemType === 'movie') openMovieDetails(item); else { currentType = 'live'; playItem(item); } };
                container.appendChild(card);
            });
        }

        async function renderCastListFromTMDB(actorList) {
            const list = document.getElementById('dt-cast-list'); const section = document.getElementById('cast-section');
            list.innerHTML = ''; let actors = [];
            if(typeof actorList === 'string') actors = actorList.split(',').map(s => s.trim()).filter(s=>s).slice(0, 10);
            else if (Array.isArray(actorList)) actors = actorList.map(a => a.name).slice(0, 10);
            if(actors.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block';
            for (const actor of actors) {
                const img = document.createElement('img'); img.className = 'cast-img'; img.src = 'https://placehold.co/100?text=' + actor.charAt(0);
                img.onclick = () => searchByActorTMDB(actor); list.appendChild(img);
                fetchActorImage(actor).then(url => { if(url) img.src = url; });
            }
        }
        async function fetchActorImage(name) { try { const url = `https://api.themoviedb.org/3/search/person?api_key=${CONFIG.tmdbKey}&query=${encodeURIComponent(name)}`; const res = await fetch(url); const data = await res.json(); if (data.results && data.results.length > 0 && data.results[0].profile_path) return `https://image.tmdb.org/t/p/w185${data.results[0].profile_path}`; } catch (e) {} return null; }

        async function openMovieDetails(item) {
            showLoader(true); currentItem = item; currentItem._savedType = 'movie'; 
            try {
                const url = `${CONFIG.dns}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=get_vod_info&vod_id=${item.stream_id}`;
                const res = await fetch(url); const data = await res.json(); const info = data.info || {};
                
                document.getElementById('dt-title').innerText = info.name || item.name;
                document.getElementById('dt-plot').innerText = info.plot || info.description || "Sem sinopse.";
                const backUrl = (info.backdrop_path && info.backdrop_path.length) ? info.backdrop_path[0] : (info.movie_image || item.stream_icon);
                document.getElementById('dt-header-bg').style.backgroundImage = `url('${backUrl}')`;
                document.getElementById('dt-poster').src = info.movie_image || item.stream_icon;
                
                let metaHtml = `<span class="meta-tag">${info.releasedate || ''}</span>`;
                if(info.rating) metaHtml += `<span class="meta-tag">⭐ ${info.rating}</span>`;
                if(info.genre) metaHtml += `<span class="meta-tag">${info.genre}</span>`;
                document.getElementById('dt-meta').innerHTML = metaHtml;

                renderCastListFromTMDB(info.actors || info.cast);
                loadHybridRecommendations(item);
                document.getElementById('dt-episodes-area').style.display = 'none';
                
                const playBtn = document.getElementById('dt-btn-play');
                const history = JSON.parse(localStorage.getItem('watch_history') || '[]');
                const found = history.find(h => h.fullItem && h.fullItem.stream_id === item.stream_id && h.type === 'movie');
                
                if(found && found.time && found.duration) {
                    const mins = Math.floor(found.time / 60);
                    playBtn.innerHTML = `<i class="fas fa-play"></i> Continuar (${mins}m)`;
                } else { playBtn.innerHTML = `<i class="fas fa-play"></i> Assistir`; }
                
                playBtn.onclick = () => { currentType = 'movie'; playItem(item); };
                updateFavButtonDetails(item.stream_id);
                document.getElementById('details-overlay').style.display = 'flex';
                updateBackButton(); 
            } catch(e) { console.error(e); alert("Erro detalhes."); }
            showLoader(false);
        }

        async function openSeriesDetails(item) {
            showLoader(true); currentItem = item; currentItem._savedType = 'series'; const seriesId = item.series_id;
            try {
                const url = `${CONFIG.dns}/player_api.php?username=${CONFIG.user}&password=${CONFIG.pass}&action=get_series_info&series_id=${seriesId}`;
                const res = await fetch(url); const data = await res.json(); currentSeriesData = data; const info = data.info;
                
                document.getElementById('dt-title').innerText = info.name;
                document.getElementById('dt-plot').innerText = info.plot || "Sem descrição.";
                const backUrl = info.backdrop_path && info.backdrop_path.length ? info.backdrop_path[0] : info.cover;
                document.getElementById('dt-header-bg').style.backgroundImage = `url('${backUrl}')`;
                document.getElementById('dt-poster').src = info.cover;
                
                let metaHtml = `<span class="meta-tag">${info.releaseDate || ''}</span>`;
                if(info.rating) metaHtml += `<span class="meta-tag">⭐ ${info.rating}</span>`;
                if(info.genre) metaHtml += `<span class="meta-tag">${info.genre}</span>`;
                document.getElementById('dt-meta').innerHTML = metaHtml;
                
                renderCastListFromTMDB(info.cast);
                document.getElementById('similar-section').style.display = 'none';

                const playBtn = document.getElementById('dt-btn-play');
                let lastWatchedEp = null; let lastTime = 0;
                let allEps = []; if(data.episodes) Object.values(data.episodes).forEach(seasonEps => allEps = allEps.concat(seasonEps));
                for(const ep of allEps) {
                    const prog = JSON.parse(localStorage.getItem(`series_progress_${ep.id}`));
                    if(prog && prog.lastUpdated && prog.lastUpdated > lastTime) { lastTime = prog.lastUpdated; lastWatchedEp = ep; }
                }
                if(lastWatchedEp) {
                    playBtn.innerHTML = `<i class="fas fa-play"></i> Continuar S${lastWatchedEp.season}:E${lastWatchedEp.episode_num}`;
                    playBtn.onclick = () => playEpisode(lastWatchedEp);
                } else {
                    playBtn.innerHTML = `<i class="fas fa-play"></i> Assistir S1:E1`;
                    if(data.episodes) {
                        const firstSeasonKey = Object.keys(data.episodes)[0];
                        if(firstSeasonKey && data.episodes[firstSeasonKey].length > 0) { playBtn.onclick = () => playEpisode(data.episodes[firstSeasonKey][0]); }
                    }
                }
                updateFavButtonDetails(seriesId);
                document.getElementById('dt-episodes-area').style.display = 'block';
                renderSeasons(data.episodes);
                document.getElementById('details-overlay').style.display = 'flex';
                updateBackButton();
            } catch(e) { console.error(e); }
            showLoader(false);
        }

        function closeDetails() { document.getElementById('details-overlay').style.display = 'none'; updateBackButton(); }
        function updateFavButtonDetails(id) {
            const favBtn = document.getElementById('dt-btn-fav');
            let favs = JSON.parse(localStorage.getItem('my_favorites') || '[]');
            const exists = favs.find(f => (f.stream_id || f.series_id) === id);
            if(exists) { favBtn.innerHTML = '<i class="fas fa-check"></i> Salvo'; favBtn.style.background = 'rgba(255,255,255,0.4)'; } 
            else { favBtn.innerHTML = '<i class="fas fa-plus"></i> Lista'; favBtn.style.background = 'rgba(255,255,255,0.2)'; }
        }
        function toggleFavoriteFromDetails() {
            if(!currentItem) return; toggleFavoriteDirectly(currentItem, currentItem._savedType);
            updateFavButtonDetails(currentItem.stream_id || currentItem.series_id);
        }
        function renderSeasons(episodesData) {
            const tabsContainer = document.getElementById('season-tabs'); const listContainer = document.getElementById('episodes-list');
            tabsContainer.innerHTML = ''; listContainer.innerHTML = '';
            if(!episodesData) return;
            const seasonKeys = Object.keys(episodesData);
            if(seasonKeys.length === 0) { listContainer.innerHTML = 'Sem episódios.'; return; }
            seasonKeys.forEach((key, index) => {
                const btn = document.createElement('div'); btn.className = 'season-tab';
                btn.innerText = `Temp ${key}`; if(index === 0) btn.classList.add('active');
                btn.onclick = () => { document.querySelectorAll('.season-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); renderEpisodeList(episodesData[key]); };
                tabsContainer.appendChild(btn);
            }); renderEpisodeList(episodesData[seasonKeys[0]]);
        }
        function renderEpisodeList(episodes) {
            const container = document.getElementById('episodes-list'); container.innerHTML = '';
            const watchedList = JSON.parse(localStorage.getItem('watched_episodes') || '[]');
            episodes.forEach(ep => {
                const div = document.createElement('div'); div.className = 'episode-item';
                const icon = watchedList.includes(ep.id) ? '<i class="fas fa-check" style="color:var(--success)"></i>' : '<i class="fas fa-play"></i>';
                div.innerHTML = `<div class="ep-play-icon">${icon}</div><div style="flex:1"><div class="ep-title">${ep.title}</div></div>`;
                div.onclick = () => playEpisode(ep);
                container.appendChild(div);
            });
        }
        function playEpisode(ep) {
            const video = document.getElementById('videoPlayer');
            document.getElementById('player-overlay').style.display = 'flex';
            const ext = ep.container_extension || 'mp4';
            const url = `${CONFIG.dns}/series/${CONFIG.user}/${CONFIG.pass}/${ep.id}.${ext}`;
            video.src = url;
            const savedData = JSON.parse(localStorage.getItem(`series_progress_${ep.id}`));
            if(savedData && savedData.time) video.currentTime = savedData.time;
            video.ontimeupdate = () => {
                localStorage.setItem(`series_progress_${ep.id}`, JSON.stringify({ time: video.currentTime, duration: video.duration || 0, lastUpdated: Date.now() }));
                if(currentItem && video.duration > 0) addToHistory(currentItem, video.currentTime, video.duration, true);
                if(video.duration > 0 && video.currentTime > video.duration * 0.9) markEpisodeWatched(ep.id);
            };
            video.onended = () => markEpisodeWatched(ep.id);
            updateBackButton();
        }
        function markEpisodeWatched(epId) {
            let watched = JSON.parse(localStorage.getItem('watched_episodes') || '[]');
            if(!watched.includes(epId)) { watched.push(epId); localStorage.setItem('watched_episodes', JSON.stringify(watched)); }
        }
        function playItem(item, startTime = 0) {
            currentItem = item; const video = document.getElementById('videoPlayer');
            document.getElementById('player-overlay').style.display = 'flex'; updateFavoriteIcon();
            let id = item.stream_id || item.series_id; let url = '';
            if(currentType === 'live') url = `${CONFIG.dns}/live/${CONFIG.user}/${CONFIG.pass}/${id}.m3u8`;
            else if(currentType === 'movie') url = `${CONFIG.dns}/movie/${CONFIG.user}/${CONFIG.pass}/${id}.${item.container_extension || 'mp4'}`;
            if(Hls.isSupported() && currentType === 'live') { const hls = new Hls(); hls.loadSource(url); hls.attachMedia(video); } else { video.src = url; }
            video.ontimeupdate = null;
            if(currentType === 'movie') {
                const history = JSON.parse(localStorage.getItem('watch_history') || '[]');
                const found = history.find(h => h.fullItem && (h.fullItem.stream_id || h.fullItem.series_id) === id && h.type === 'movie');
                if(found && found.time) video.currentTime = found.time;
                video.ontimeupdate = () => { if(video.duration > 0) addToHistory(item, video.currentTime, video.duration); };
            }
            updateBackButton();
        }
        function closePlayer() {
            const v = document.getElementById('videoPlayer'); v.pause(); v.src = ''; v.ontimeupdate = null;
            document.getElementById('player-overlay').style.display = 'none';
            if(document.getElementById('details-overlay').style.display === 'flex' && currentSeriesData) {
                if(currentItem._savedType === 'series') openSeriesDetails(currentItem); else if(currentItem._savedType === 'movie') openMovieDetails(currentItem);
            }
            if(document.getElementById('home-view').style.display !== 'none') renderHomeHistory();
            updateBackButton();
        }
        function toggleFavorite() { if(!currentItem) return; toggleFavoriteDirectly(currentItem, currentType); updateFavoriteIcon(); }
        function toggleFavoriteDirectly(item, type) {
            let favs = JSON.parse(localStorage.getItem('my_favorites') || '[]');
            const id = item.stream_id || item.series_id;
            const exists = favs.find(f => (f.stream_id || f.series_id) === id);
            if(exists) favs = favs.filter(f => (f.stream_id || f.series_id) !== id);
            else { item._savedType = type; favs.push(item); }
            localStorage.setItem('my_favorites', JSON.stringify(favs));
        }
        function updateFavoriteIcon() {
            if(!currentItem) return;
            let favs = JSON.parse(localStorage.getItem('my_favorites') || '[]');
            const id = currentItem.stream_id || currentItem.series_id;
            const exists = favs.find(f => (f.stream_id || f.series_id) === id);
            const icon = document.querySelector('#fav-btn i');
            if(exists) icon.className = 'fas fa-heart'; else icon.className = 'far fa-heart';
        }
        function addToHistory(item, time, duration, isSeries = false) {
            let hist = JSON.parse(localStorage.getItem('watch_history') || '[]');
            const id = item.stream_id || item.series_id;
            hist = hist.filter(h => h.fullItem && (h.fullItem.stream_id || h.fullItem.series_id) !== id);
            hist.unshift({ id: id, img: item.stream_icon || item.cover, type: isSeries ? 'series' : currentType, time: time, duration: duration, fullItem: item });
            if(hist.length > 20) hist.pop();
            localStorage.setItem('watch_history', JSON.stringify(hist));
        }
        function renderHomeHistory() {
            const history = JSON.parse(localStorage.getItem('watch_history') || '[]').filter(h => h.fullItem && isSafe(h.fullItem.name || h.fullItem.title));
            const container = document.getElementById('history-scroll'); const section = document.getElementById('home-history');
            if(history.length === 0) { section.style.display = 'none'; return; }
            section.style.display = 'block'; container.innerHTML = '';
            const uniqueHistory = []; const seen = new Set();
            history.forEach(h => { const clean = cleanName(h.fullItem.name || h.fullItem.title); const norm = normalizeStr(clean); if(!seen.has(norm)) { seen.add(norm); uniqueHistory.push(h); } });
            uniqueHistory.forEach(h => {
                const card = document.createElement('div'); card.className = 'card-home';
                let progressHtml = ''; if(h.time && h.duration) { const pct = (h.time / h.duration) * 100; progressHtml = `<div class="card-progress-container"><div class="card-progress-fill" style="width: ${pct}%"></div></div>`; }
                const img = h.img || IMG_FALLBACK;
                card.innerHTML = `<img src="${img}"><div class="card-title">${h.fullItem.name || h.fullItem.title}</div>${progressHtml}`;
                card.onclick = () => { if(h.type === 'series') openSeriesDetails(h.fullItem); else if(h.type === 'movie') openMovieDetails(h.fullItem); else { currentType = h.type; playItem(h.fullItem, h.time); } };
                container.appendChild(card);
            }); setupHorizontalScroll();
        }
        function setActiveNav(id) { document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); if(id) { const btn = document.getElementById(id); if(btn) btn.classList.add('active'); } }
        function showLoader(show) { document.getElementById('loader').style.display = show ? 'block' : 'none'; }
    </script>
</body>
</html>
